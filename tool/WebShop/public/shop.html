<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ショップ管理 - <span id="shop-name-display"></span></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/YOUR_FONT_AWESOME_KIT_ID.js" crossorigin="anonymous"></script>
</head>

<body class="bg-gray-100 font-noto">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="px-6 py-4">
                <div class="font-bold text-xl mb-2 flex items-center">
                    <span>ショップ管理 - </span><span id="shop-name-display" class="ml-2"></span>
                    <img id="shop-header-image" src="" alt="ショップヘッダー画像"
                        class="w-12 h-12 ml-2 rounded-full object-cover cursor-pointer">
                </div>
            </div>

            <div id="login-form" class="px-6 pt-4 pb-2">
                <input type="password" id="password" placeholder="パスワード"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
                <button onclick="login()"
                    class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">ログイン</button>
            </div>

            <div id="management-area" style="display: none;" class="px-6 pt-4 pb-2">
                <h2 class="text-2xl font-bold mb-4">アイテム管理</h2>
                <ul id="item-list" class="list-none p-0">
                </ul>
                <p id="no-items-message" class="text-gray-500 mt-4" style="display: none;">
                    販売中のアイテムはありません。<br>アイテムを追加してください。</p>

                <div class="mt-6">

                    <button onclick="updateShopHeader()"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded inline-flex items-center">
                        <i class="fas fa-image mr-2"></i>
                        ヘッダー画像を変更
                    </button>

                </div>
            </div>
        </div>
        <div id="shop-name" style="display:none;"></div>
    </div>

    <script>
      const shopName = decodeURIComponent(window.location.pathname.split('/').pop());
        document.getElementById('shop-name-display').textContent = shopName;
        document.getElementById('shop-name').textContent = shopName;

        let isLoggedIn = false;

        async function login() {
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`/api/shop/${shopName}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    document.getElementById('login-form').style.display = 'none';
                    document.getElementById('management-area').style.display = 'block';
                    isLoggedIn = true;
                    loadShopHeader();
                    loadItems();
                } else {
                    alert('パスワードが間違っています。');
                }
            } catch (error) {
                console.error("ログインエラー:", error);
                alert('ログイン中にエラーが発生しました。');
            }
        }

        async function loadShopHeader() {
            try {
                const response = await fetch(`/api/shop/${shopName}`);
                if (response.ok) {
                    const shopData = await response.json();
                    if (shopData.imageUrl) {
                        document.getElementById('shop-header-image').src = shopData.imageUrl;
                    }
                }
            } catch (error) {
                console.error("ショップヘッダー取得エラー:", error);
            }
        }

        async function updateShopHeader() {
            const imageUrl = prompt("新しいヘッダー画像のURLを入力してください (空欄で削除):", document.getElementById('shop-header-image').src);

            try {
                const response = await fetch(`/api/shop/${shopName}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imageUrl: imageUrl === "" ? null : imageUrl }),
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('shop-header-image').src = data.shop.imageUrl || "";
                    alert('ショップヘッダーを更新しました。');
                } else {
                    alert('ショップヘッダーの更新に失敗しました。');
                }
            } catch (error) {
                console.error("ショップヘッダー更新エラー:", error);
                alert('ショップヘッダーの更新中にエラーが発生しました。');
            }
        }

        async function loadItems() {
            if (!isLoggedIn) {
                return;
            }

            try {
                const response = await fetch(`/api/shop/${shopName}/items`);
                if (response.ok) {
                    const items = await response.json();
                    displayItems(items);
                } else {
                    alert('アイテムの取得に失敗しました。');
                }
            } catch (error) {
                console.error("アイテム取得エラー:", error);
                alert('アイテムの取得中にエラーが発生しました。');
            }
        }

        function displayItems(items) {
            const itemList = document.getElementById('item-list');
            const noItemsMessage = document.getElementById('no-items-message');
            itemList.innerHTML = '';

            if (items.length === 0) {
                noItemsMessage.style.display = 'block';
            } else {
                noItemsMessage.style.display = 'none';
                items.forEach(item => {
                    const itemElement = document.createElement('li');
                    itemElement.textContent = `${item.name} x${item.quantity} - ${item.price} ${item.currency}`;
                    itemList.appendChild(itemElement);
                });
            }
        }


        loadItems();

        // ヘッダー画像の更新ボタン
        const headerImage = document.getElementById('shop-header-image');
        if (headerImage) {
            headerImage.addEventListener('click', updateShopHeader);
        }
    </script>
</body>

</html>