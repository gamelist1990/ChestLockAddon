<!DOCTYPE html>
<html>

<head>
    <title>WebVC</title>
    <meta charset="utf-8">
    <style>
        /* ... (スタイルは変更なし) ... */
    </style>
</head>

<body>
    <h1>WebVC</h1>

    <div>
        <label for="username">ユーザー名:</label>
        <select id="username"></select>
        <button id="connectBtn">接続</button>
        <button id="disconnectBtn" disabled>切断</button>
    </div>

    <div>
        <h2>近くのユーザー:</h2>
        <ul id="userList"></ul>
    </div>

    <div>
        <h2>ログ:</h2>
        <div id="log"></div>
    </div>

    <script>
        const usernameSelect = document.getElementById('username');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const userList = document.getElementById('userList');
        const logDiv = document.getElementById('log');

        let socket;
        let mediaRecorder;
        let audioContext;
        let audioQueue = [];
        let playing = false;

        window.addEventListener('load', async () => {
            await fetchPlayerList();
        });

        connectBtn.addEventListener('click', () => {
            const username = usernameSelect.value;
            if (username) {
                if (!audioContext) {
                    audioContext = new AudioContext({ sampleRate: 48000 }); // Opusは48kHzを推奨
                }
                connectWebSocket(username);
                startRecording();
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                logMessage('ユーザー名を選択してください');
            }
        });

        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.close();
            }
            stopRecording(); // 録音を停止
        });

        async function fetchPlayerList() {
            try {
                const response = await fetch(`/playerList`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updatePlayerSelect(data.players);
            } catch (error) {
                console.error('プレイヤーリストの取得に失敗しました:', error);
                logMessage('プレイヤーリストの取得に失敗しました');
            }
        }

        function updatePlayerSelect(players) {
            usernameSelect.innerHTML = '';
            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player;
                option.textContent = player;
                usernameSelect.appendChild(option);
            });
        }

        function updateUserList(users) {
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = `${user.username} (距離: ${user.distance.toFixed(2)})`;
                userList.appendChild(li);
            });
        }

        function logMessage(message) {
            const p = document.createElement('p');
            p.textContent = message;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function connectWebSocket(username) {
            const serverUrl = `ws://localhost:19134/?username=${username}`;
            socket = new WebSocket(serverUrl);
            socket.binaryType = 'arraybuffer';

            socket.addEventListener('open', () => {
                logMessage('サーバーに接続しました');
                socket.send(JSON.stringify({ type: 'getPlayerList' }));
            });

            socket.addEventListener('message', (event) => {
                if (event.data instanceof ArrayBuffer) {
                    console.log("Received audio data:", event.data.byteLength, "bytes");
                    audioQueue.push(event.data);
                    if (!playing) {
                        playFromQueue();
                    }
                } else {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'playerList') {
                            updatePlayerSelect(data.players);
                        } else if (data.type === 'userList') {
                            updateUserList(data.users);
                        }
                    } catch (error) {
                        console.error("Error parsing JSON:", error);
                    }
                }
            });

            socket.addEventListener('close', () => {
                logMessage('サーバーから切断しました');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                userList.innerHTML = '';
            });

            socket.addEventListener('error', (error) => {
                console.error('WebSocket エラー:', error);
                logMessage('エラーが発生しました');
            });
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

                mediaRecorder.addEventListener('dataavailable', (event) => {
                    if (event.data.size > 0) {
                        sendAudio(event.data);
                    }
                });

                mediaRecorder.start(20); // 20msごとにデータを送信 (Opusのフレームサイズに合わせる)
            } catch (error) {
                console.error('マイクアクセスエラー:', error);
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    logMessage('マイクへのアクセスが拒否されました。ブラウザの設定を確認してください。');
                } else if (error.name === 'NotFoundError') {
                    logMessage('マイクが見つかりません。');
                } else {
                    logMessage('マイクへのアクセス中にエラーが発生しました。');
                }
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        function sendAudio(audioBlob) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(audioBlob);
            }
        }

        function playFromQueue() {
            if (!playing && audioQueue.length > 0) {
                playing = true;
                let audioData = audioQueue.shift();

                // Opusデータをデコード
                audioContext.decodeAudioData(audioData.slice()) // audioDataをコピーして渡す
                    .then(audioBuffer => {
                        const source = audioContext.createBufferSource();
                        source.buffer = audioBuffer;
                        source.connect(audioContext.destination);
                        source.start();

                        source.onended = () => {
                            playing = false;
                            playFromQueue();
                        };
                    })
                    .catch(error => {
                        console.error('Error decoding audio data:', error);
                        logMessage('音声データのデコード中にエラーが発生しました');
                        playing = false;
                        playFromQueue();
                    });
            }
        }
    </script>
</body>

</html>