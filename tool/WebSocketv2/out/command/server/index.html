<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Server Control Panel</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="style.css">
</head>


<body>
    <div class="hamburger-menu" onclick="toggleNav()">
        <div></div>
        <div></div>
        <div></div>
    </div>

    <nav id="main-nav">
        <ul>
            <li onclick="showPage('console-page')">
                <span class="nav-icon">ğŸ®</span> ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
            </li>
            <li onclick="showPage('players-page')">
                <span class="nav-icon">ğŸ‘¥</span> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¢ºèª
            </li>
            <li onclick="showPage('status-page')">
                <span class="nav-icon">ğŸ“Š</span> ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            </li>
            <li onclick="showPage('ban-page')">
                <span class="nav-icon">ğŸš«</span> BAN
            </li>
            <li onclick="showPage('map-page')">
                <span class="nav-icon">ğŸŒ</span> ãƒãƒƒãƒ—
            </li>
            <li><button id="logout-button" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></li>
        </ul>
    </nav>

    <div class="container" id="login-form">
        <h2><span class="login-icon">ğŸ”’</span> ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <div class="input-group">
            <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
            <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" required>
        </div>
        <div class="input-group">
            <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
            <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
        </div>
        <div class="autologin-container">
            <input type="checkbox" id="autologin" name="autologin">
            <label for="autologin">è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³</label>
        </div>
        <button onclick="login()"><span class="login-icon">ãƒ­ã‚°ã‚¤ãƒ³</span></button>
        <div id="login-error"></div>
    </div>

    <div class="page" id="console-page">
        <div class="container">
            <h1><span class="server-icon">ğŸ–¥ï¸</span> Minecraft ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«</h1>
            <div class="info-box">
                <div id="playerCount"><span class="info-icon">ğŸ‘¥</span> ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: 0</div>
                <div id="uptime"><span class="info-icon">â±ï¸</span> èµ·å‹•æ™‚é–“: ä¸æ˜</div>
            </div>
            <div class="console-input-area">
                <div class="console-container">
                    <textarea id="console" readonly></textarea>
                </div>
                <div class="input-container">
                    <input type="text" id="commandInput" placeholder="ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›...">
                    <button onclick="sendCommand()"> <span class="send-icon">é€ä¿¡</span> </button>
                </div>
            </div>
        </div>
    </div>

    <div class="page" id="players-page">
        <div class="container">
            <h2><span class="server-icon">ğŸ‘¥</span> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¢ºèª</h2>
            <div class="info-box">
                <div id="playerCount2"><span class="info-icon">ğŸ‘¥</span> ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: 0</div>
                <div id="uptime2"><span class="info-icon">â±ï¸</span> èµ·å‹•æ™‚é–“: ä¸æ˜</div>
            </div>
            <ul class="player-list" id="player-list">
            </ul>
        </div>
    </div>

    <div class="page" id="status-page">
        <div class="container">
            <h2><span class="status-icon">ğŸ“Š</span> ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèª</h2>
            <button onclick="checkServerStatus()"><span class="status-icon">ğŸ”„</span> çŠ¶æ…‹ç¢ºèª</button>
            <div id="server-status" class="status-info"></div>
        </div>
    </div>
    <!-- BAN Page -->
    <div class="page" id="ban-page">
        <div class="container">
            <h2><span class="ban-icon">ğŸš«</span> BAN / Unban</h2>
            <div class="ban-form">
                <!-- BAN ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="input-group player-select">
                    <label for="banPlayerName">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å (BAN):</label>
                    <select id="banPlayerName">
                        <option value="">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ</option>
                        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                    </select>
                </div>
                <div class="input-group">
                    <label for="banReason">ç†ç”±:</label>
                    <input type="text" id="banReason" placeholder="BANç†ç”±" required>
                </div>
                <div class="input-group">
                    <label for="banDuration">æœŸé–“:</label>
                    <input type="text" id="banDuration" placeholder="ä¾‹: 1d, 6h, 30m (ç©ºæ¬„ã§æ°¸ä¹…BAN)" required>
                </div>
                <button onclick="banPlayer()">BAN</button>

                <!-- Unban ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="input-group">
                    <label for="unbanPlayerName">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å (Unban):</label>
                    <input type="text" id="unbanPlayerName" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›" required>
                </div>
                <button onclick="unbanPlayer()">Unban</button>
            </div>
            <h2><span class="ban-icon">ğŸ“œ</span> BANãƒªã‚¹ãƒˆ</h2>
            <ul class="ban-list" id="ban-list">
                <!-- BANã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </ul>
        </div>
    </div>

    <div class="page" id="map-page">
        <div class="container">
            <h2><span class="map-icon">ğŸŒ</span> ãƒãƒƒãƒ—</h2>
            <div id="mapid"></div>
            <ul class="player-list-map" id="player-list-map">
                <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã¯ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </ul>
        </div>
    </div>

    <script>
        let ws = null;
        let loggedIn = false;
        let playerCache = {};
        let commandHistory = [];
        let currentHistoryIndex = -1;
        let selectedPlayerName = ''; // é¸æŠã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let updateBan = true;
        let map = null;
        let playerMarkers = {};

        // ãƒšãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function showPage(pageId) {
            $('.page').removeClass('active');
            $('#' + pageId).addClass('active');

            const nav = $('#main-nav');
            if (nav.hasClass('active')) {
                nav.removeClass('active');
                $('.container').css('padding-left', '');
            }

            // BANãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«BANãƒªã‚¹ãƒˆã‚’æ›´æ–°
            if (pageId === 'ban-page') {
                updateBanList();
            }

            if (pageId === 'map-page') {
                initializeMap();
            }
        }

        //ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        function toggleNav() {
            const nav = $('#main-nav');
            if (nav.hasClass('active')) {
                nav.removeClass('active');
                $('.container').css('padding-left', '');
            } else {
                nav.addClass('active');
                $('.container').css('padding-left', '280px');
            }
        }

        function toggleDisplay() {
            const loginForm = $('#login-form');
            const hamburgerMenu = $('.hamburger-menu');
            const nav = $('#main-nav');

            if (loggedIn) {
                loginForm.hide();
                hamburgerMenu.show();
                showPage('console-page');
            } else {
                loginForm.show();
                hamburgerMenu.hide();
                nav.removeClass('active');
                $('.page').removeClass('active');
            }
        }

        // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã®å‡¦ç†
        function checkAutoLogin() {
            if (localStorage.getItem('autoLogin') === 'true') {
                const username = localStorage.getItem('username');
                const password = localStorage.getItem('password');
                if (username && password) {
                    $('#username').val(username);
                    $('#password').val(password);
                    $('#autologin').prop('checked', true);
                    login();
                }
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function login() {
            const username = $('#username').val();
            const password = $('#password').val();
            const autoLogin = $('#autologin').prop('checked');

            fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loggedIn = true;
                        if (autoLogin) {
                            localStorage.setItem('username', username);
                            localStorage.setItem('password', password);
                            localStorage.setItem('autoLogin', 'true');
                        } else {
                            localStorage.removeItem('username');
                            localStorage.removeItem('password');
                            localStorage.removeItem('autoLogin');
                        }
                        toggleDisplay();
                        connectWebSocket(username, password);
                    } else {
                        $('#login-error').text('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    $('#login-error').text('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                });
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function logout() {
            loggedIn = false;
            localStorage.removeItem('username');
            localStorage.removeItem('password');
            localStorage.removeItem('autoLogin');
            toggleDisplay();
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function connectWebSocket(username, password) {
            let wsUrl = 'wss://bfxmknk4-80.asse.devtunnels.ms/';
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log(`WebSocket connected to ${wsUrl}`);
                ws.send(JSON.stringify({ type: 'authenticate', username, password }));
            };

            ws.onmessage = handleWebSocketMessage;

            ws.onerror = (error) => {
                console.error(`WebSocket error on ${wsUrl}:`, error);
                ws.close();
                connectLocalWebSocket(username, password);
            };

            ws.onclose = (event) => {
                console.log(`WebSocket connection to ${wsUrl} closed`, event);
            };
        }

        function connectLocalWebSocket(username, password) {
            const localWsUrl = `ws://${window.location.host}`;
            console.log(`Trying to connect to local WebSocket server: ${localWsUrl}`);
            ws = new WebSocket(localWsUrl);

            ws.onopen = () => {
                console.log(`WebSocket connected to ${localWsUrl}`);
                ws.send(JSON.stringify({ type: 'authenticate', username, password }));
            };

            ws.onmessage = handleWebSocketMessage;

            ws.onerror = (error) => {
                console.error(`WebSocket error on ${localWsUrl}:`, error);
            };

            ws.onclose = () => {
                console.log(`WebSocket connection to ${localWsUrl} closed`);
            };
        }

        // WebSocket ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã™ã‚‹å…±é€šé–¢æ•°
        function handleWebSocketMessage(event) {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'playerCount':
                    $('#playerCount').html(`<span class="info-icon">ğŸ‘¥</span> ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${data.data}`);
                    $('#playerCount2').html(`<span class="info-icon">ğŸ‘¥</span> ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${data.data}`);
                    break;
                case 'console':
                    const consoleElement = $('#console');
                    consoleElement.val(consoleElement.val() + data.data + '\n');
                    consoleElement.scrollTop(consoleElement.prop("scrollHeight"));
                    break;
                case 'uptime':
                    $('#uptime').html(`<span class="info-icon">â±ï¸</span> èµ·å‹•æ™‚é–“: ${data.data}`);
                    $('#uptime2').html(`<span class="info-icon">â±ï¸</span> èµ·å‹•æ™‚é–“: ${data.data}`);
                    break;
                case 'onlinePlayers':
                    updatePlayerLists(data.data);
                    updatePlayerSelectDropdown(data.data);
                    if (map) {
                        updatePlayerMarkers(data.data);
                    }
                    break;
                case 'banList':
                    if (updateBan) {
                        updateBanListDisplay(data.data);
                    }
                    break;
                case 'error':
                    console.error('WebSocket error:', data.message);
                    if (data.message === 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ') {
                        loggedIn = false;
                        toggleDisplay();
                        ws.close();
                    }
                    break;
            }
        }

        // ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
        function sendCommand() {
            if (!loggedIn || !ws) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            const command = $('#commandInput').val();
            ws.send(JSON.stringify({ type: 'command', command }));

            // ã‚³ãƒãƒ³ãƒ‰å±¥æ­´ã®ç®¡ç†
            if (commandHistory[0] !== command) {
                commandHistory.unshift(command); // æœ€æ–°ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…ˆé ­ã«è¿½åŠ 
            }
            currentHistoryIndex = -1; // å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            $('#commandInput').val('');
        }

        // ã‚³ãƒãƒ³ãƒ‰å…¥åŠ›æ¬„ã§â†‘ã‚­ãƒ¼ã‚„â†“ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        $('#commandInput').keydown(function (e) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (currentHistoryIndex < commandHistory.length - 1) {
                    currentHistoryIndex++;
                    $('#commandInput').val(commandHistory[currentHistoryIndex]);
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    $('#commandInput').val(commandHistory[currentHistoryIndex]);
                } else {
                    currentHistoryIndex = -1;
                    $('#commandInput').val('');
                }
            }
        });

        // ã‚µãƒ¼ãƒãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
        function checkServerStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    let statusHTML = '';
                    Object.keys(data).forEach(address => {
                        const serverData = data[address];
                        if (serverData.status === 'online') {
                            statusHTML += `<p><span class="status-icon">âœ”</span> ${address}: ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</p>`;
                            statusHTML += `<p>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°: ${serverData.players.online} / ${serverData.players.max}</p>`;
                            statusHTML += `<p>MOTD: ${serverData.motd.clean.join('<br>')}</p>`;
                            if (typeof serverData.ping !== 'undefined') {
                                statusHTML += `<p>Ping: ${serverData.ping} ms</p>`;
                            }
                        } else if (serverData.status === 'offline') {
                            statusHTML += `<p><span class="status-icon offline">âœ–</span> ${address}: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</p>`;
                        } else {
                            statusHTML += `<p><span class="status-icon error">âš </span> ${address}: çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼</p>`;
                            statusHTML += `<p>ã‚¨ãƒ©ãƒ¼è©³ç´°: ${serverData.error}</p>`;
                        }
                    });

                    $('#server-status').html(statusHTML);
                })
                .catch(error => {
                    console.error('Status check error:', error);
                    $('#server-status').html('<span class="status-icon error">âš </span> çŠ¶æ…‹ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                });
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ãŠã‚ˆã³ã€æ–°è¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ ã€é€€å‡ºãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‰Šé™¤
        function updatePlayerLists(newPlayers) {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’ã‚½ãƒ¼ãƒˆã—ã¦æ›´æ–°
            let sortedPlayers = newPlayers;

            sortedPlayers.sort((a, b) => {
                const nameA = a.name || '';
                const nameB = b.name || '';

                // æ—¥æœ¬èªã‹ã©ã†ã‹ã®åˆ¤å®š
                const isJapaneseA = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(nameA);
                const isJapaneseB = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(nameB);

                // æ—¥æœ¬èªãŒå…ˆã€ãã‚Œä»¥å¤–ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§æ¯”è¼ƒ
                if (isJapaneseA && !isJapaneseB) {
                    return -1;
                } else if (!isJapaneseA && isJapaneseB) {
                    return 1;
                } else {
                    return nameA.localeCompare(nameB);
                }
            });

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
            updatePlayerList(sortedPlayers);
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updatePlayerList(players) {
            const playerList = $('#player-list');
            playerList.empty();

            if (players.length === 0) {
                playerList.append($('<li>').text("ç¾åœ¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã„ã¾ã›ã‚“"));
            } else {
                players.forEach(player => {
                    const li = $('<li>');
                    li.html(`<strong>${player.name}</strong> (UUID: ${player.uuid} - Ping: ${player.ping}ms)`);
                    if (player.position) {
                        li.append(`<br>ä½ç½®: X=${player.position.x}, Y=${player.position.y}, Z=${player.position.z}`);
                    } else {
                        li.append(`<br>ä½ç½®: ä¸æ˜`);
                    }
                    playerList.append(li);
                });
            }
        }

        // BAN/Unbanãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
        function sendAuthenticatedRequest(url, data) {
            const username = localStorage.getItem('username');
            const password = localStorage.getItem('password');

            if (!username || !password) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return Promise.reject('No login information found');
            }

            const base64Credentials = btoa(username + ':' + password);

            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Basic ${base64Credentials}`
                },
                body: JSON.stringify(data)
            });
        }

        // BANãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
        function banPlayer() {
            const playerName = $('#banPlayerName').val();
            const reason = $('#banReason').val();
            const duration = $('#banDuration').val();

            if (!playerName) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            sendAuthenticatedRequest('/ban', { type: 'ban', playerName, reason, duration })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${playerName} ã‚’BANã—ã¾ã—ãŸã€‚`);
                        updateBanList();
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                        $('#banPlayerName').val('');
                        $('#banReason').val('');
                        $('#banDuration').val('');
                        selectedPlayerName = '';
                    } else {
                        alert(`BANãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('BAN request error:', error);
                    alert('BANãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                });
        }

        // Unbanãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°(ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›)
        function unbanPlayer() {
            const playerName = $('#unbanPlayerName').val();

            if (!playerName) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            sendAuthenticatedRequest('/unban', { type: 'unban', playerName })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${playerName} ã®BANã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`);
                        updateBanList();
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                        $('#unbanPlayerName').val('');
                        selectedPlayerName = playerName; // é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã‚»ãƒƒãƒˆ
                    } else {
                        alert(`Unbanãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Unban request error:', error);
                    alert('Unbanãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                });
        }

        // Unbanãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹é–¢æ•°(ãƒªã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯)
        function unbanPlayerFromList(playerName) {
            sendAuthenticatedRequest('/unban', { type: 'unban', playerName })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${playerName} ã®BANã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`);
                        updateBanList();
                        selectedPlayerName = playerName;
                    } else {
                        alert(`Unbanãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Unban request error:', error);
                    alert('Unbanãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                });
        }

        $('#banPlayerName').on('change', function () {
            selectedPlayerName = $(this).val();
            console.log("é¸æŠä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:", selectedPlayerName);
        });

        // BANãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateBanList() {
            if (!ws) {
                console.error('WebSocket is not connected.');
                return;
            }
            // BANãƒªã‚¹ãƒˆã®æ›´æ–°ã‚’WebSocketã‚µãƒ¼ãƒãƒ¼ã«è¦æ±‚
            ws.send(JSON.stringify({ type: 'getBanList' }));
        }

        // BANãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateBanListDisplay(banList) {
            const banListElement = $('#ban-list');
            banListElement.empty();

            if (banList.length === 0) {
                banListElement.append($('<li>').text("ç¾åœ¨BANã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã„ã¾ã›ã‚“"));
            } else {
                banList.forEach(ban => {
                    const li = $('<li>');
                    const expires = ban.expiresAt ? new Date(ban.expiresAt).toLocaleString() : 'æ°¸ä¹…';
                    li.html(`<strong>${ban.name}</strong> (UUID: ${ban.uuid})<br>ç†ç”±: ${ban.reason}<br>BANã—ãŸç®¡ç†è€…: ${ban.bannedBy}<br>æœŸé™: ${expires}`);

                    // Unban ç¢ºèªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
                    const unbanConfirmMenu = $(`<div class="unban-confirm">
                        <p>${ban.name} ã®BANã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                        <button class="confirm">ã¯ã„</button>
                        <button class="cancel">ã„ã„ãˆ</button>
                    </div>`);
                    li.append(unbanConfirmMenu);

                    li.on('click', function (event) {
                        event.stopPropagation();
                        $('.unban-confirm').hide(); // ä»–ã®ç¢ºèªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éš ã™
                        unbanConfirmMenu.show(); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¢ºèªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                        updateBan = false;
                    });

                    // ã¯ã„ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    unbanConfirmMenu.find('.confirm').on('click', function (event) {
                        event.stopPropagation();
                        unbanPlayerFromList(ban.name);
                        unbanConfirmMenu.hide();
                        updateBan = true;
                    });

                    // ã„ã„ãˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    unbanConfirmMenu.find('.cancel').on('click', function (event) {
                        event.stopPropagation();
                        unbanConfirmMenu.hide();
                        updateBan = true;
                    });

                    banListElement.append(li);
                });
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updatePlayerSelectDropdown(players) {
            const playerSelect = $('#banPlayerName');
            playerSelect.empty();
            playerSelect.append($('<option>').val('').text('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ'));

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’ã‚½ãƒ¼ãƒˆ (åå‰ã®ã¿ã‚’ã‚½ãƒ¼ãƒˆ)
            let sortedPlayerNames = players.map(player => player.name).sort((a, b) => {
                // æ—¥æœ¬èªã‹ã©ã†ã‹ã®åˆ¤å®š
                const isJapaneseA = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(a);
                const isJapaneseB = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(b);

                // æ—¥æœ¬èªãŒå…ˆã€ãã‚Œä»¥å¤–ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§æ¯”è¼ƒ
                if (isJapaneseA && !isJapaneseB) {
                    return -1;
                } else if (!isJapaneseA && isJapaneseB) {
                    return 1;
                } else {
                    return a.localeCompare(b);
                }
            });

            sortedPlayerNames.forEach(playerName => {
                playerSelect.append($('<option>').val(playerName).text(playerName));
            });

            // ã‚‚ã—é¸æŠã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒªã‚¹ãƒˆã«ã¾ã å­˜åœ¨ã™ã‚‹å ´åˆã¯ã€é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹
            if (selectedPlayerName && sortedPlayerNames.includes(selectedPlayerName)) {
                playerSelect.val(selectedPlayerName);
            }
        }


        function initializeMap() {
            if (!map) {
                map = L.map('mapid').setView([0, 0], 2); // ãƒãƒƒãƒ—ã®åˆæœŸãƒ“ãƒ¥ãƒ¼ã‚’è¨­å®š

                // ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ ï¼ˆä¾‹ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªèƒŒæ™¯ï¼‰
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 7,
                    minZoom: -3,
                    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // ã‚ºãƒ¼ãƒ åˆ¶é™ã‚’èª¿æ•´
                map.setMinZoom(-3);

                // åº§æ¨™ (0, 0) ã«èµ¤ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                L.marker([0, 0], {
                    icon: L.icon({
                        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
            }

            updateMapMarkers();
            updatePlayerListForMap();
        }


        function updateMapMarkers() {
            if (!map) return;

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã—ã€ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°ã™ã‚‹
            ws.send(JSON.stringify({ type: 'getOnlinePlayers' }));
        }

        function updatePlayerMarkers(players) {
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã€æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            Object.values(playerMarkers).forEach(marker => map.removeLayer(marker));
            playerMarkers = {};

            players.forEach(player => {
                if (player.position) {
                    // ç·¯åº¦çµŒåº¦ã‚’Minecraftã®åº§æ¨™ã‹ã‚‰è¨ˆç®—ï¼ˆ1/100ã«ç¸®å°ï¼‰
                    let lat = -player.position.z / 50;
                    let lng = player.position.x / 50;

                    // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                    let marker = L.marker([lat, lng]).addTo(map);
                    marker.bindPopup(`<b>${player.name}</b><br>X: ${player.position.x}, Y: ${player.position.y}, Z: ${player.position.z}`);
                    playerMarkers[player.uuid] = marker;
                }
            });
        }


        function updatePlayerListForMap() {
            const playerListMap = $('#player-list-map');
            playerListMap.empty();

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æƒ…å ±ã‚’å–å¾—
            ws.send(JSON.stringify({ type: 'getOnlinePlayers' }));
        }


        function focusOnPlayer(playerName) {
            for (let uuid in playerMarkers) {
                let marker = playerMarkers[uuid];
                let popup = marker.getPopup();
                if (popup && popup.getContent().includes(playerName)) {
                    map.flyTo(marker.getLatLng(), 7);
                    marker.openPopup();
                    break;
                }
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°ãŠã‚ˆã³ã€æ–°è¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¿½åŠ ã€é€€å‡ºãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‰Šé™¤
        function updatePlayerLists(newPlayers) {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’ã‚½ãƒ¼ãƒˆã—ã¦æ›´æ–°
            let sortedPlayers = newPlayers;

            sortedPlayers.sort((a, b) => {
                const nameA = a.name || '';
                const nameB = b.name || '';

                // æ—¥æœ¬èªã‹ã©ã†ã‹ã®åˆ¤å®š
                const isJapaneseA = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(nameA);
                const isJapaneseB = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¯]/.test(nameB);

                // æ—¥æœ¬èªãŒå…ˆã€ãã‚Œä»¥å¤–ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã§æ¯”è¼ƒ
                if (isJapaneseA && !isJapaneseB) {
                    return -1;
                } else if (!isJapaneseA && isJapaneseB) {
                    return 1;
                } else {
                    return nameA.localeCompare(nameB);
                }
            });

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
            updatePlayerList(sortedPlayers);
            updatePlayerListMap(sortedPlayers);
        }

        //ãƒãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
        function updatePlayerListMap(players) {
            const playerListMap = $('#player-list-map');
            playerListMap.empty();

            players.forEach(player => {
                const li = $('<li>');
                li.html(`<strong>${player.name}</strong>`);
                if (player.position) {
                    li.append(` - <a href="#" onclick="focusOnPlayer('${player.name}')">ä½ç½®ã«ç§»å‹•</a>`);
                }
                playerListMap.append(li);
            });
        }



        // åˆæœŸè¡¨ç¤º
        toggleDisplay();
        checkAutoLogin();
    </script>
</body>

</html>